<html>

<head>
    <title>WEBGL</title>
    <meta http-equiv="content-type" content="text/html; charset=utf8">
    <link href="css/smoothness/jquery-ui-1.8.13.custom.css" type="text/css" rel="stylesheet"/>
    <script type="text/javascript" src="js/gl/glMatrix-0.9.5.min.js"></script>
    <script type="text/javascript" src="js/gl/webgl-utils.js"></script>
    <script type="text/javascript" src="js/gl/webgl-debug.js"></script>
    <script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.8.13.custom.min.js"></script>
    <script type="text/javascript">


        var gl;
        var shaderProgram;


    </script>
    <script type="text/javascript" src="js/ActionMapper.js"></script>
    <script type="text/javascript" src="js/Texture.js"></script>
    <script type="text/javascript" src="js/Model.js"></script>
    <script type="text/javascript" src="js/Bullet.js"></script>
    <script type="text/javascript" src="js/Ship.js"></script>
    <script type="text/javascript" src="js/Game.js"></script>


    <script id="per-fragment-lighting-fs" type="x-shader/x-fragment">
    precision mediump float;

    varying vec3 vTransformedNormal;
    varying vec4 vPosition;
    varying vec2 vTextureCoord;

    uniform float uMaterialShininess;

    uniform vec3 uLightAmbient;

    uniform vec3 uLightPosition;
    uniform vec3 uLightSpecular;
    uniform vec3 uLightDiffuse;
    uniform sampler2D uSampler;
    uniform float uAlpha;
    //blended element is drawn without lightning so it's always really bright
    uniform bool uUseLighting;

    void main(void) {
        vec3 lightWeighting;

            vec3 lightDirection = normalize(uLightPosition - vPosition.xyz);
            vec3 normal = normalize(vTransformedNormal);

            float specularLightWeighting = 0.0;

                vec3 eyeDirection = normalize(-vPosition.xyz);
                vec3 reflectionDirection = reflect(-lightDirection, normal);

                specularLightWeighting = pow(max(dot(reflectionDirection, eyeDirection), 0.0), uMaterialShininess);

            float diffuseLightWeighting = max(dot(normal, lightDirection), 0.0);
            if(uUseLighting)
              lightWeighting = uLightAmbient + uLightSpecular * specularLightWeighting + uLightDiffuse * diffuseLightWeighting;
            else
              lightWeighting = vec3(1.0, 1.0, 1.0);



            //vec4 fragmentColor = vec4(1.0, 1.0, 1.0, 1.0);
            vec4 fragmentColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));

        gl_FragColor = vec4(fragmentColor.rgb * lightWeighting, fragmentColor.a * uAlpha);
    }

    </script>

    <script id="per-fragment-lighting-vs" type="x-shader/x-vertex">
    attribute vec3 aVertexPosition;
    attribute vec3 aVertexNormal;
    attribute vec2 aTextureCoord;

    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;
    uniform mat3 uNMatrix;

    varying vec3 vTransformedNormal;
    varying vec4 vPosition;
    varying vec2 vTextureCoord;


    void main(void) {


        vPosition = uMVMatrix * vec4(aVertexPosition, 1.0);
        vTextureCoord = aTextureCoord;
        gl_Position = uPMatrix * vPosition;

        vTransformedNormal = uNMatrix * aVertexNormal;
    }

    </script>

    <script type="text/javascript">


        function initShaders() {
            var fragmentShader = getShader(gl, "per-fragment-lighting-fs");
            var vertexShader = getShader(gl, "per-fragment-lighting-vs");

            shaderProgram = gl.createProgram();
            gl.attachShader(shaderProgram, vertexShader);
            gl.attachShader(shaderProgram, fragmentShader);
            gl.linkProgram(shaderProgram);

            if (!gl.getProgramParameter(shaderProgram, gl.LINK_STATUS)) {
                alert("Could not initialise shaders");
            }

            gl.useProgram(shaderProgram);

            shaderProgram.aVertexPosition = gl.getAttribLocation(shaderProgram, "aVertexPosition");
            gl.enableVertexAttribArray(shaderProgram.aVertexPosition);

            shaderProgram.textureCoordAttribute = gl.getAttribLocation(shaderProgram, "aTextureCoord");
            gl.enableVertexAttribArray(shaderProgram.textureCoordAttribute);

            shaderProgram.aVertexNormal = gl.getAttribLocation(shaderProgram, "aVertexNormal");
            gl.enableVertexAttribArray(shaderProgram.aVertexNormal);


            shaderProgram.uPMatrix = gl.getUniformLocation(shaderProgram, "uPMatrix");
            shaderProgram.uMVMatrix = gl.getUniformLocation(shaderProgram, "uMVMatrix");
            shaderProgram.uNMatrix = gl.getUniformLocation(shaderProgram, "uNMatrix");
            shaderProgram.samplerUniform = gl.getUniformLocation(shaderProgram, "uSampler");

            shaderProgram.uMaterialShininess = gl.getUniformLocation(shaderProgram, "uMaterialShininess");
            shaderProgram.uAmbient = gl.getUniformLocation(shaderProgram, "uAmbient");
            //shaderProgram.uMaterialDiffuse = gl.getUniformLocation(shaderProgram, "uMaterialDiffuse");
            //shaderProgram.uMaterialSpecular = gl.getUniformLocation(shaderProgram, "uMaterialSpecular");


            shaderProgram.uLightPosition = gl.getUniformLocation(shaderProgram, "uLightPosition");
            shaderProgram.uLightAmbient = gl.getUniformLocation(shaderProgram, "uLightAmbient");
            shaderProgram.uLightDiffuse = gl.getUniformLocation(shaderProgram, "uLightDiffuse");
            shaderProgram.uLightSpecular = gl.getUniformLocation(shaderProgram, "uLightSpecular");


            shaderProgram.alphaUniform = gl.getUniformLocation(shaderProgram, "uAlpha");
            shaderProgram.useLightingUniform = gl.getUniformLocation(shaderProgram, "uUseLighting");


        }

        function getShader(gl, id) {

            var shaderScript = document.getElementById(id);
            if (!shaderScript) {
                return null;
            }

            var str = "";
            var k = shaderScript.firstChild;
            while (k) {
                if (k.nodeType == 3) {
                    str += k.textContent;
                }
                k = k.nextSibling;
            }

            var shader;
            if (shaderScript.type == "x-shader/x-fragment") {
                shader = gl.createShader(gl.FRAGMENT_SHADER);
            } else if (shaderScript.type == "x-shader/x-vertex") {
                shader = gl.createShader(gl.VERTEX_SHADER);
            } else {
                return null;
            }

            gl.shaderSource(shader, str);
            gl.compileShader(shader);

            if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                alert(gl.getShaderInfoLog(shader));
                return null;
            }
            return shader;
        }


        function logGLCall(functionName, args) {
            console.log("gl." + functionName + "(" +
                    WebGLDebugUtils.glFunctionArgsToString(functionName, args) + ")");
        }


        function webGLStart() {
            var canvas = document.getElementById("canvas");
            var game;
            game = new Game(gl, 'asteroid');
            game.init(canvas);

        }

    </script>

    <style type="text/css">
        #loadingtext {
            position: absolute;
            top: 250px;
            left: 150px;
            font-size: 2em;
            color: white;
        }
    </style>
</head>
<body onload="webGLStart();">


<canvas id="canvas" style="border: none;" width="800" height="600"></canvas>


<div id="bottom">
    <table style="padding=0px">
        <tr>
            <td>light X:</td>
            <td id='slider-x-value' width='30px'>25</td>
            <td width="150px">
                <div id="slider-x"/>
            </td>
        </tr>
        <tr>
            <td>light Y:</td>
            <td id="slider-y-value" width="30px">2</td>
            <td width="150px">
                <div id="slider-y"/>
            </td>
        </tr>
        <tr>
            <td>light Z:</td>
            <td id="slider-z-value" width="30px">-15</td>
            <td width="150px">
                <div id="slider-z"/>
            </td>
        </tr>
    </table>

</div>
<script>

    $('#slider-x').slider({value: 54.0, min: -100, max: 100, step: 0.1, slide: updateLightPosition, change: updateLightPosition});
    $('#slider-y').slider({value: -70.0, min: -100, max: 100, step: 0.1, slide: updateLightPosition, change: updateLightPosition});
    $('#slider-z').slider({value: 12, min: -100, max: 100, step: 0.1, slide: updateLightPosition, change: updateLightPosition});


    function updateLightPosition() {
        var x = $('#slider-x').slider("value");
        var y = $('#slider-y').slider("value");
        var z = $('#slider-z').slider("value");
        gl.uniform3f(shaderProgram.uLightPosition, x, y, z);
        $('#slider-x-value').html(x);
        $('#slider-y-value').html(y);
        $('#slider-z-value').html(z);
    }


</script>


</body>
</html>
